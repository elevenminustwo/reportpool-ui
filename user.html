<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>User Template</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link href="css/site.css" rel="stylesheet">
  
  
</head>

<body >
	
	<div class="container text-white">
	
	<h2>Bilgi Islem Daire Baskanligi Rapor Giris Ekrani</h2>
	<form name="reportForm">
	<label>Lutfen birim seciniz:</label>
	<select id="dropdown" class="form-control">
	<option></option>
	</select>
	<div id="unitSelectError" class="text-danger"></div>
	<div class="form-group">
		<label for="exampleFormControlTextarea1">Raporunuz:</label>
		<textarea class="form-control" id="exampleFormControlTextarea1" rows="5"></textarea>
	</div>
	<div class="row">
	<div class="col">
	 <div class="custom-file">
		
		<input id="multipleFileUploadInput" type="file" class="custom-file-input" multiple>
    <label id="multipleFileUploadLabel" class="custom-file-label" for="multipleFileUploadInput">Eklemek istediginiz dosyayı seciniz...</label>
    <div class="invalid-feedback">Example invalid custom file feedback</div>
		
		<!--
		<div class="multiple-upload">
					<input id="multipleFileUploadInput" type="file" name="files" class="file-input" multiple/>
		-->
			<div class="upload-response">
					<div id="multipleFileUploadError"></div>
					<div id="multipleFileUploadSuccess"></div>
			</div>
	


	</div>
	</div>
	</div>
	<div class="text-right mt-3">
	<button type="submit" id="submitButton" class="btn btn-success float-right ml-3">Raporu Isle</button>
	<button class="btn btn-dark">Kaydet</button>
	</div>
	</form>
	</div>

  <!-- Footer -->
  <footer class="footer">
    <p class="copyright ">Copyright © 2019 Akdeniz Üniversitesi Tüm Hakları Saklıdır.</p>
  </footer>

<!-- Bootstrap core JavaScript -->
<script type="text/javascript">
	


	var unitArray;
	var menu = document.getElementById("dropdown");

	$(document).ready(function() {  
     $.getJSON("http://localhost:8080/api/getUserUnits/1", 
					function(data) { 
						console.log(data);
						unitArray = data;
						
						for(var i = 0; i < unitArray.length; i++) {
							console.log(unitArray[i][1]);
							var option = document.createElement("option");
							option.text = unitArray[i][1] + "/" + unitArray[i][2];
							menu.add(option);
						}
					}
     ); 
	});



	$('#multipleFileUploadInput').on('change',function(){
                //get the file name
								var fileNames = "";
                var files = $(this)[0].files;
								for (var i = 0; i < files.length; i++) {
        					fileNames += (files[i].name) + " ";
    						}

								console.log(fileNames);
                //replace the "Choose a file" label
                $(this).next('.custom-file-label').html(fileNames);
            })


function uploadMultipleFiles(files) {

'use strict';

var multipleUploadForm = document.querySelector('#multipleUploadForm');
var multipleFileUploadInput = document.querySelector('#multipleFileUploadınput');
var multipleFileUploadError = document.querySelector('#multipleFileUploadError');
var multipleFileUploadSuccess = document.querySelector('#multipleFileUploadSuccess')

var reportForm = document.querySelector('#reportForm')

    var formData = new FormData();
    for(var index = 0; index < files.length; index++) {
        formData.append("files", files[index]);
    }

    var xhr = new XMLHttpRequest();
    xhr.open("POST", "http://localhost:8080/uploadMultipleFiles");

    xhr.onload = function() {
        console.log(xhr.responseText);
        var response = JSON.parse(xhr.responseText);
        if(xhr.status == 200) {
            multipleFileUploadError.style.display = "none";
            var content = "";
            for(var i = 0; i < response.length; i++) {
							  if(i == 0) {
									content += "<p>All Files Uploaded Successfully</p>";
								}
                content += "<p>DownloadUrl : <a href='" + response[i].fileDownloadUri + "' target='_blank'>" + response[i].fileDownloadUri + "</a></p>";
            }
            multipleFileUploadSuccess.innerHTML = content;
            multipleFileUploadSuccess.style.display = "block";
        } else {
            multipleFileUploadSuccess.style.display = "none";
            multipleFileUploadError.innerHTML = (response && response.message) || "Some Error Occurred";
        }
    }
		xhr.send(formData);
	}

	function addReport() {
		var icerik = document.getElementById("exampleFormControlTextarea1").value;  
		document.getElementById("exampleFormControlTextarea1").value = "";
		
		var reportObject = {"reportId":null,"title":"Rapor","text":"default","isCompleted":1,"dateCompleted":"2006-12-24","userId":1,"departmentunitId":1};
		console.log("unit to save: " + unitArray[dropdown.selectedIndex - 1][0]);
		reportObject["departmentunitId"] = unitArray[dropdown.selectedIndex - 1][0];
		reportObject["text"] = icerik;
		
		var request = new XMLHttpRequest();
		var reportJson = JSON.stringify(reportObject);
		
		request.open("POST", "http://localhost:8080/savereport");
		request.setRequestHeader("Content-type", "application/json");
		request.send(reportJson);

		document.getElementById("unitSelectError").innerHTML = "";
	}





            



	// on submit, necessary functions get invoked
	reportForm.addEventListener('submit', function(event){
    var files = multipleFileUploadInput.files;
    if(files.length === 0) {
		}
		if(dropdown.selectedIndex == 0) {
			console.log("No unit selected");
			document.getElementById("unitSelectError").innerHTML = "Please select a unit";
			event.preventDefault();
			return;
		}
		addReport();
		uploadMultipleFiles(files);

    event.preventDefault();
  }, true);


</script>



</body>

</html>
